  name: Build and Deploy to Production
  # Nom affichÃ© dans l'onglet GitHub Actions

  on:
    push:
      branches: [ master ]
  # DÃ©clenche le workflow uniquement sur push vers la branche master

  env:
    REGISTRY: docker.io
    # Registry DockerHub par dÃ©faut
    BACKEND_IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/mellisync-backend
    # Nom de l'image backend avec ton username DockerHub
    FRONTEND_IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/mellisync-frontend
    # Nom de l'image frontend avec ton username DockerHub

  jobs:
    test-backend:
      runs-on: ubuntu-latest
      # Lance ce job sur une machine Ubuntu

      services:
        postgres:
          image: postgres:15-alpine
          # Lance PostgreSQL en arriÃ¨re-plan pour les tests
          env:
            POSTGRES_PASSWORD: postgres
            POSTGRES_DB: mellisync_test
            # Configuration de la DB de test
          # VÃ©rifie que PostgreSQL est prÃªt avant de continuer
          options: >-
            --health-cmd pg_isready
            --health-interval 10s
            --health-timeout 5s
            --health-retries 5
          ports:
            - 5432:5432
            # Expose PostgreSQL sur localhost:5432

      steps:
      - uses: actions/checkout@v4
        # RÃ©cupÃ¨re ton code source

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          # Installe Node.js 22 (comme ton environnement local)
          cache: 'npm'
          cache-dependency-path: server/package-lock.json
          # Cache les dÃ©pendances npm pour aller plus vite

      - name: Install backend dependencies
        run: |
          cd server
          npm ci
        # Va dans le dossier server et installe les dÃ©pendances

      - name: Generate Prisma client
        run: |
          cd server
          npx prisma generate
        # GÃ©nÃ¨re le client Prisma pour TypeScript

      - name: Run backend tests
        run: |
          cd server
          npm test
        # Lance les tests backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/mellisync_test
          # URL de connexion Ã  la DB de test

    build-and-deploy:
      needs: test-backend
      # Ce job attend que test-backend rÃ©ussisse
      runs-on: ubuntu-latest

      steps:
      - uses: actions/checkout@v4
        # RÃ©cupÃ¨re le code source

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
        # Se connecte Ã  DockerHub avec tes secrets GitHub

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        # Configure Docker pour les builds avancÃ©s

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./server
          # Build depuis le dossier server/
          push: true
          # Push l'image sur DockerHub
          tags: ${{ env.BACKEND_IMAGE_NAME }}:latest,${{ env.BACKEND_IMAGE_NAME }}:${{ github.sha }}
          # Tag avec "latest" et l'ID du commit
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # Utilise le cache GitHub pour accÃ©lÃ©rer les builds

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./client
          # Build depuis le dossier client/
          push: true
          tags: ${{ env.FRONTEND_IMAGE_NAME }}:latest,${{ env.FRONTEND_IMAGE_NAME }}:${{ github.sha }}
          # MÃªme logique que le backend

      - name: Deploy notification
        run: |
          echo "ðŸš€ Deployment successful!"
          echo "Backend: ${{ env.BACKEND_IMAGE_NAME }}:${{ github.sha }}"
          echo "Frontend: ${{ env.FRONTEND_IMAGE_NAME }}:${{ github.sha }}"
        # Affiche un message de succÃ¨s avec les noms des images
      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_SSH_PORT }}
          script: |
            cd /home/docker/mellisync
            echo "ðŸ”„ Pulling latest images..."
            docker compose -f docker-compose.prod.yml --env-file .env.prod pull
            echo "ðŸš€ Restarting services..."
            docker compose -f docker-compose.prod.yml --env-file .env.prod up -d
            echo "ðŸ§¹ Cleaning up old images..."
            docker system prune -f
            echo "âœ… Deployment completed!"